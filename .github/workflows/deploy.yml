name: Django Docker Deploy (Zero Downtime)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 ubuntu@${{ secrets.EC2_HOST }} bash << 'EOF'
            set -e

            PROJECT_DIR="/home/ubuntu/mydjangoproject/Blog_Project"

            echo "üìÅ Moving to project directory"
            cd $PROJECT_DIR

            echo "üì• Pulling latest code"
            git fetch origin
            git reset --hard origin/main

            echo "üê≥ Docker status check"
            docker info > /dev/null

            echo "üì¶ Pulling Docker images (non-fatal)"
            docker compose pull || true

            echo "üöÄ Building & starting containers"
            docker compose up -d --build

            echo "‚è≥ Waiting for Django app to be healthy..."
            HEALTH_OK=0
            for i in {1..15}; do
              if curl -sf http://localhost/health/ > /dev/null; then
                echo "‚úÖ App is healthy"
                HEALTH_OK=1
                break
              fi
              echo "‚è±Ô∏è Retry $i..."
              sleep 5
            done

            if [ $HEALTH_OK -ne 1 ]; then
              echo "‚ùå App failed health check!"
              docker compose ps
              docker compose logs django_web --tail=50
              exit 1
            fi

            echo "üéâ Deployment successful!"
            exit 0
          EOF
