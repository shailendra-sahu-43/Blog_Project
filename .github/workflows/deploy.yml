name: Deploy Django to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Repo checkout
    - name: Checkout code
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Setup SSH using EC2_SSH_KEY
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    # 3Ô∏è‚É£ Deploy to EC2
    - name: Deploy to EC2
      run: |
        ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
        set -e

        cd /home/ubuntu/mydjangoproject/Blog_Project

        echo "üîÑ Pulling latest code"
        git pull origin main

        echo "üêç Activating virtualenv"
        source /home/ubuntu/mydjangoproject/venv/bin/activate

        echo "üì¶ Installing dependencies"
        pip install -r requirements.txt

        echo "üîê Exporting env variables"
        export DJANGO_SECRET_KEY="${{ secrets.DJANGO_SECRET_KEY }}"
        export AWS_REGION="${{ secrets.AWS_REGION }}"

        echo "üóÑÔ∏è Running migrations"
        python manage.py migrate --noinput

        echo "üé® Collecting static files"
        python manage.py collectstatic --noinput

        echo "üöÄ Restarting services"
        sudo systemctl restart gunicorn
        sudo systemctl restart nginx

        echo "‚úÖ Deployment finished"
        EOF
